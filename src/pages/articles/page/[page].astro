---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { ARTICLE_PAGE_SIZE } from '../../../lib/constants';
import { excerptFromBody } from '../../../lib/excerpt';

export async function getStaticPaths() {
	const pageSize = ARTICLE_PAGE_SIZE;
	const allPosts = (await getCollection('article')).sort(
		(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
	);
	const total = allPosts.length;
	const lastPage = Math.max(1, Math.ceil(total / pageSize));
	return Array.from({ length: lastPage - 1 }, (_, i) => ({
		params: { page: String(i + 2) },
		props: {
			posts: allPosts.slice((i + 1) * pageSize, (i + 2) * pageSize),
			currentPage: i + 2,
			lastPage,
			total,
		},
	}));
}

const { posts, currentPage, lastPage } = Astro.props;
---

<BaseLayout
	title={`Articles — page ${currentPage}`}
	description={`Articles, page ${currentPage} of ${lastPage}.`}
>
	<header class="mb-14">
		<h1 class="text-3xl font-semibold tracking-tight text-slate-900 dark:text-slate-100">Articles</h1>
		<p class="mt-2 text-lg text-slate-600 dark:text-slate-400">
			Page {currentPage} of {lastPage}.
		</p>
	</header>

	<nav aria-label="Article list">
		<ol class="space-y-12 list-none p-0 m-0">
			{posts.map((post) => (
				<li>
					<article class="border-b border-slate-200 pb-12 last:border-0 dark:border-slate-700">
						<h2 class="text-xl font-semibold tracking-tight">
							<a
								href={`/articles/${post.id}`}
								class="text-slate-900 underline decoration-slate-300 underline-offset-4 hover:decoration-slate-500 focus:outline focus:decoration-slate-700 dark:text-slate-100 dark:decoration-slate-500 dark:hover:decoration-slate-400 dark:focus:decoration-slate-400"
							>
								{post.data.title}
							</a>
						</h2>
						<div class="mt-1 flex flex-wrap items-baseline gap-x-3 gap-y-0 text-sm text-slate-500 dark:text-slate-400">
							<time datetime={post.data.pubDate.toISOString()}>
								{post.data.pubDate.toLocaleDateString('en-US', {
									year: 'numeric',
									month: 'long',
									day: 'numeric',
								})}
							</time>
							{post.data.updatedDate ? (
								<time datetime={post.data.updatedDate.toISOString()} class="text-slate-400 dark:text-slate-500">
									Updated {post.data.updatedDate.toLocaleDateString('en-US', {
										year: 'numeric',
										month: 'long',
										day: 'numeric',
									})}
								</time>
							) : null}
						</div>
						<p class="mt-3 text-slate-700 leading-relaxed dark:text-slate-300">
							{post.data.summary ?? excerptFromBody(post.body)}
						</p>
					</article>
				</li>
			))}
		</ol>
	</nav>

	<nav aria-label="Article pagination" class="mt-14 flex flex-wrap items-center gap-4 text-slate-600 dark:text-slate-400">
		<a
			href={currentPage === 2 ? '/articles' : `/articles/page/${currentPage - 1}`}
			class="font-medium underline decoration-slate-300 underline-offset-4 hover:decoration-slate-500 dark:decoration-slate-500 dark:hover:decoration-slate-400"
		>
			← Newer posts
		</a>
		{currentPage < lastPage ? (
			<a
				href={`/articles/page/${currentPage + 1}`}
				class="font-medium underline decoration-slate-300 underline-offset-4 hover:decoration-slate-500 dark:decoration-slate-500 dark:hover:decoration-slate-400"
			>
				Older posts →
			</a>
		) : null}
	</nav>
</BaseLayout>
