---
import imageAssets from 'virtual:image-assets';

interface Props {
	/** Image asset id (global folder name, or local folder name when postId is set). */
	id: string;
	/** Optional caption override for this use. */
	caption?: string;
	/** When set (e.g. from an article), resolve local asset postId/id. Omit for global only. */
	postId?: string;
}

const { id, caption: captionProp, postId: postIdProp } = Astro.props;
const postId = postIdProp ?? (Astro.locals as { postId?: string })?.postId;
const localKey = postId ? `${postId}/${id}` : null;
const asset = (localKey && imageAssets[localKey]) ?? imageAssets[id];
if (!asset) {
	console.warn(`[Figure] Unknown image id: ${localKey ?? id}`);
}
const caption = captionProp ?? (asset && typeof asset === 'object' ? asset.caption : undefined);
const attribution = asset && typeof asset === 'object' ? asset.attribution : undefined;
---

{asset ? (
	<figure class="my-6">
		<img
			src={asset.url}
			alt={asset.alt}
			class="max-w-full rounded border border-slate-200 dark:border-slate-700"
			loading="lazy"
			decoding="async"
		/>
		{(caption ?? attribution) ? (
			<figcaption class="mt-2 text-sm text-slate-500 [&_a]:underline [&_a]:decoration-slate-400 [&_a]:underline-offset-2 hover:[&_a]:decoration-slate-600 dark:text-slate-400 dark:[&_a]:decoration-slate-500 dark:hover:[&_a]:decoration-slate-400">
				{caption ? <span>{caption}</span> : null}
				{attribution ? (
					<span class={caption ? ' block mt-1' : ''} set:html={attribution} />
				) : null}
			</figcaption>
		) : null}
	</figure>
) : null}
